
# Database Schema

This document outlines the database structure for the Crypto Trading Platform, detailing tables, relationships, and data models.

## Overview

The platform uses Supabase (PostgreSQL) as its primary database, with tables organized by functional domains. The schema is designed to support:

- User authentication and profiles
- Trading and portfolio management
- AI trading bots and strategies
- Market data and analysis
- News and sentiment tracking
- API connections and monitoring
- Alerts and notifications

## Core Tables

### Users and Authentication

#### profiles
Extends the Supabase auth.users table with additional user information.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key, references auth.users.id |
| username | text | User's chosen username |
| display_name | text | User's display name |
| avatar_url | text | URL to user's avatar image |
| created_at | timestamp | Record creation timestamp |
| updated_at | timestamp | Record update timestamp |

#### settings
Stores user-specific application settings.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References profiles.id |
| category | text | Settings category (appearance, trading, etc.) |
| settings | jsonb | JSON object containing settings data |
| created_at | timestamp | Record creation timestamp |
| updated_at | timestamp | Record update timestamp |

### Trading

#### trading_accounts
Manages trading accounts for users.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References profiles.id |
| name | text | Account name |
| balance | numeric | Current account balance |
| initial_balance | numeric | Initial deposit amount |
| currency | text | Account currency code |
| type | text | Account type (paper, live, etc.) |
| created_at | timestamp | Record creation timestamp |
| provider | text | Exchange or provider name |
| is_active | boolean | Whether account is active |

#### trades
Records individual trading transactions.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References profiles.id |
| account_id | uuid | References trading_accounts.id |
| asset_id | text | Asset identifier |
| asset_symbol | text | Asset symbol (e.g., BTC) |
| type | text | Trade type (buy, sell) |
| amount | numeric | Trade amount |
| price | numeric | Asset price at trade |
| total_value | numeric | Total value of trade |
| fee | numeric | Transaction fee |
| status | text | Trade status |
| executed_at | timestamp | Execution timestamp |
| created_at | timestamp | Record creation timestamp |
| notes | text | User notes |
| tags | text[] | Array of trade tags |

#### portfolios
Tracks user portfolio compositions.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References profiles.id |
| name | text | Portfolio name |
| description | text | Portfolio description |
| assets | jsonb | Asset allocation and details |
| metrics | jsonb | Performance metrics |
| created_at | timestamp | Record creation timestamp |
| updated_at | timestamp | Record update timestamp |
| is_public | boolean | Portfolio visibility setting |

### AI Trading

#### trading_bots
Manages AI trading bots configured by users.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References profiles.id |
| name | text | Bot name |
| strategy | text | Strategy type |
| status | text | Bot status (active, paused, etc.) |
| created_at | timestamp | Record creation timestamp |
| active_since | timestamp | Activation timestamp |
| performance | jsonb | Performance metrics |
| last_trade | jsonb | Details of last executed trade |
| alerts | jsonb | Configuration for bot alerts |
| underperforming | boolean | Flag for underperformance |

#### trading_signals
Records signals generated by trading bots.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References profiles.id |
| symbol | text | Asset symbol |
| type | text | Signal type (buy, sell) |
| price | numeric | Target price |
| created_at | timestamp | Signal generation timestamp |
| execution_status | text | Signal execution status |
| confidence | integer | Confidence level (0-100) |
| details | jsonb | Additional signal details |

#### ai_strategies
Stores AI trading strategy configurations.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References profiles.id |
| name | text | Strategy name |
| type | text | Strategy type |
| description | text | Strategy description |
| parameters | jsonb | Strategy parameters |
| performance | jsonb | Historical performance metrics |
| created_at | timestamp | Record creation timestamp |
| updated_at | timestamp | Record update timestamp |
| is_public | boolean | Strategy sharing setting |

### Market Data

#### market_data
Stores cryptocurrency market data.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| symbol | text | Asset symbol |
| name | text | Asset name |
| price | numeric | Current price |
| change_24h | numeric | 24-hour price change percentage |
| volume_24h | numeric | 24-hour trading volume |
| market_cap | numeric | Market capitalization |
| last_updated | timestamp | Last update timestamp |
| user_id | uuid | Optional reference to specific user data |

#### watchlists
Manages user watchlists for tracking assets.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References profiles.id |
| name | text | Watchlist name |
| assets | text[] | Array of asset symbols |
| created_at | timestamp | Record creation timestamp |
| updated_at | timestamp | Record update timestamp |

### News and Analytics

#### news_analysis
Stores news articles with sentiment analysis.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| title | text | Article title |
| url | text | Article URL |
| source | text | News source name |
| published_at | timestamp | Publication timestamp |
| sentiment | text | Sentiment classification |
| sentiment_score | numeric | Numerical sentiment score |
| summary | text | Article summary |
| created_at | timestamp | Record creation timestamp |
| user_id | uuid | Optional reference for user-specific analysis |

#### alerts
Manages user-configured price and volume alerts.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References profiles.id |
| type | text | Alert type (price, volume, technical) |
| asset_id | text | Asset identifier |
| symbol | text | Asset symbol |
| condition | jsonb | Alert conditions |
| status | text | Alert status |
| created_at | timestamp | Record creation timestamp |
| triggered_at | timestamp | Alert trigger timestamp |
| notification_channels | text[] | Notification methods |
| recurring | boolean | Whether alert is recurring |
| expires_at | timestamp | Expiration timestamp |
| notes | text | User notes |

### API and Integration

#### platform_connections
Manages external API connections.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References profiles.id |
| platform | varchar | Platform name |
| api_key | text | API key (encrypted) |
| api_secret | text | API secret (encrypted) |
| access_token | text | OAuth access token |
| access_token_secret | text | OAuth token secret |
| connected | boolean | Connection status |
| last_updated | timestamp | Last update timestamp |

#### webhooks
Configures webhook integrations.

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | References profiles.id |
| name | varchar | Webhook name |
| url | text | Webhook URL |
| events | text[] | Triggering events |
| active | boolean | Webhook status |
| created_at | timestamp | Record creation timestamp |
| updated_at | timestamp | Record update timestamp |

## Relationships

### Primary Relationships

1. **User-Centric Relationships**
   - One user can have many trading accounts (`profiles.id → trading_accounts.user_id`)
   - One user can have many trades (`profiles.id → trades.user_id`)
   - One user can have many bots (`profiles.id → trading_bots.user_id`)
   - One user can have many watchlists (`profiles.id → watchlists.user_id`)
   - One user can have many alerts (`profiles.id → alerts.user_id`)
   - One user can have many platform connections (`profiles.id → platform_connections.user_id`)

2. **Account-Trade Relationship**
   - One trading account can have many trades (`trading_accounts.id → trades.account_id`)

3. **Bot-Strategy Relationship**
   - Bots are configured with strategies (`trading_bots.strategy_id → ai_strategies.id`)

4. **Bot-Signal Relationship**
   - Bots generate trading signals (`trading_bots.id → trading_signals.bot_id`)

## Row-Level Security Policies

All tables include Row-Level Security (RLS) policies to ensure data access security:

### Example RLS Policies

```sql
-- Enable RLS on trades table
ALTER TABLE trades ENABLE ROW LEVEL SECURITY;

-- Create policy for users to view their own trades
CREATE POLICY "Users can view their own trades" 
ON trades FOR SELECT 
USING (auth.uid() = user_id);

-- Create policy for users to insert their own trades
CREATE POLICY "Users can create their own trades" 
ON trades FOR INSERT 
WITH CHECK (auth.uid() = user_id);

-- Create policy for users to update their own trades
CREATE POLICY "Users can update their own trades" 
ON trades FOR UPDATE 
USING (auth.uid() = user_id);

-- Create policy for users to delete their own trades
CREATE POLICY "Users can delete their own trades" 
ON trades FOR DELETE 
USING (auth.uid() = user_id);
```

## Indexes

Key indexes to optimize query performance:

```sql
-- Optimize user-based queries
CREATE INDEX idx_trades_user_id ON trades(user_id);
CREATE INDEX idx_trading_bots_user_id ON trading_bots(user_id);
CREATE INDEX idx_watchlists_user_id ON watchlists(user_id);

-- Optimize symbol-based queries
CREATE INDEX idx_market_data_symbol ON market_data(symbol);
CREATE INDEX idx_trades_asset_symbol ON trades(asset_symbol);

-- Optimize time-based queries
CREATE INDEX idx_trades_executed_at ON trades(executed_at);
CREATE INDEX idx_news_analysis_published_at ON news_analysis(published_at);
```

## Data Types and Constraints

- UUIDs are used for primary keys
- Foreign keys enforce referential integrity
- JSONB columns store flexible, structured data
- Text arrays store multi-value fields
- Timestamps track creation and modification times
- Security-sensitive data is stored with encryption

## Migration and Version Control

Database migrations use Supabase migrations:

- Each migration is versioned and sequential
- Migrations handle both schema and data changes
- Rollback procedures are defined for critical migrations

The database schema is designed to balance normalization for data integrity with strategic denormalization for query performance. It supports the platform's functional requirements while maintaining security through Row-Level Security policies and proper referential integrity.
